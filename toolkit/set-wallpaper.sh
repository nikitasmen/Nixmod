#!/usr/bin/env bash

# Set a specific wallpaper in Hyprland using hyprpaper
# Usage: ./set-wallpaper.sh [/path/to/wallpaper.jpg]
# If no path is provided, uses a random wallpaper from $HOME/Pictures/wallpapers

CONF="$HOME/.config/hypr/hyprpaper.conf"
LAST_WALL="$HOME/.config/hypr/last_wallpaper.txt"
WALLDIR="$HOME/Pictures/wallpapers"

# If no argument is provided, pick a random wallpaper from the default directory
if [[ -z "$1" ]]; then
    WALLPAPER=$(find "$WALLDIR" -type f \( -iname '*.jpg' -o -iname '*.png' \) | shuf -n 1)
    if [[ -z "$WALLPAPER" ]]; then
        echo "❌ No wallpapers found in $WALLDIR"
        exit 1
    fi
    echo "🎲 Selected random wallpaper: $WALLPAPER"
else
    WALLPAPER="$1"
fi

# Check if the file exists
if [[ ! -f "$WALLPAPER" ]]; then
    echo "❌ Wallpaper not found: $WALLPAPER"
    exit 1
fi

# Create config directory if it doesn't exist
mkdir -p "$(dirname "$CONF")"

# Save the wallpaper path for future reference
echo "$WALLPAPER" > "$LAST_WALL"

# Generate the hyprpaper config
echo "# Autogenerated hyprpaper config" > "$CONF"
echo "preload = $WALLPAPER" >> "$CONF"

# Set wallpaper for all monitors
for MON in $(hyprctl monitors | awk '/Monitor/ {print $2}'); do
  echo "Setting wallpaper for monitor $MON"
  echo "wallpaper = $MON,$WALLPAPER" >> "$CONF"
done

# Kill existing hyprpaper instances
pkill -x hyprpaper

# Start hyprpaper with the new config
hyprpaper &

echo "✅ Wallpaper set to: $WALLPAPER"
